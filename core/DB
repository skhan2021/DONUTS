package core;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import org.flywaydb.core.Flyway;

/**
 * DB - Database connection and management class (Singleton pattern)
 *
 * This class manages the connection to the Apache Derby embedded database.
 * It uses the Singleton pattern to ensure only one database connection exists.
 * Flyway is used for database migrations (creating tables, initial data).
 */
public class DB {
    // Database connection string for Apache Derby embedded database
    // "oakdonutsdb" is the database name, "create=true" means create if doesn't exist
    private static final String DB_URL = "jdbc:derby:oakdonutsdb;create=true";

    // Location of Flyway migration scripts (SQL files for creating tables)
    private static final String MIGRATION_DIR = "db.migrations";

    // Static instance ensures only one DB object exists (Singleton pattern)
    private static DB instance = null;

    // The actual database connection
    private final Connection mConnection;

    /**
     * Private constructor - enforces Singleton pattern
     * Only getInstance() can create the DB object
     */
    private DB() throws SQLException {
        // Run database migrations first (create tables if needed)
        migrateDb();

        // Establish connection to the database
        mConnection = DriverManager.getConnection(DB_URL);
    }

    /**
     * Get the single instance of the DB class (Singleton pattern)
     * If instance doesn't exist yet, create it
     */
    public static DB getInstance() {
        if (instance == null) {
            try {
                instance = new DB();
            } catch (SQLException ex) {
                // If database initialization fails, print error and exit
                System.err.println("Database Error: " + ex.toString());
                System.exit(1);
            }
        }
        return instance;
    }

    /**
     * Execute an SQL UPDATE, INSERT, or DELETE statement
     * Returns the number of rows affected
     */
    public int executeUpdate(String sql) throws SQLException {
        return mConnection.createStatement().executeUpdate(sql);
    }

    /**
     * Execute an SQL SELECT query
     * Returns a ResultSet containing query results
     */
    public ResultSet executeQuery(String sql) throws SQLException {
        return mConnection.createStatement().executeQuery(sql);
    }

    /**
     * Create a PreparedStatement for parameterized queries
     * PreparedStatements are safer than raw SQL - they prevent SQL injection
     *
     * Example usage:
     *   PreparedStatement stmt = db.getPreparedStatement("SELECT * FROM MenuItem WHERE id = ?");
     *   stmt.setInt(1, itemId);
     *   ResultSet rs = stmt.executeQuery();
     */
    public PreparedStatement getPreparedStatement(String sql) throws SQLException {
        return mConnection.prepareStatement(sql);
    }

    /**
     * Create a PreparedStatement with auto-generated key retrieval
     * Used when inserting records and you need to get the generated ID
     *
     * Example usage:
     *   PreparedStatement stmt = db.getPreparedStatement(
     *       "INSERT INTO Orders (total) VALUES (?)",
     *       Statement.RETURN_GENERATED_KEYS
     *   );
     *   stmt.setDouble(1, 25.99);
     *   stmt.executeUpdate();
     *   ResultSet keys = stmt.getGeneratedKeys();
     *   if (keys.next()) {
     *       int orderId = keys.getInt(1);  // Get the auto-generated ID
     *   }
     */
    public PreparedStatement getPreparedStatement(String sql, int autoGeneratedKeys) throws SQLException {
        return mConnection.prepareStatement(sql, autoGeneratedKeys);
    }

    /**
     * Run Flyway database migrations
     *
     * Flyway looks for SQL files named like:
     *   V1__Create_MenuItem_Table.sql
     *   V2__Create_Order_Table.sql
     *   V3__Create_OrderItem_Table.sql
     *
     * It runs them in order and keeps track of which have been applied.
     * If you add a new migration file, Flyway will automatically run only
     * that new migration on next startup.
     */
    private void migrateDb() {
        Flyway flyway = new Flyway();
        flyway.setDataSource(DB_URL, null, null);
        flyway.setLocations(MIGRATION_DIR);
        flyway.migrate();
    }
}
