package gui;

import entity.MenuItem;
import entity.MenuItemDAO;
import entity.Order;
import entity.OrderDAO;
import entity.OrderItem;
import entity.OrderItemDAO;
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.time.format.DateTimeFormatter;
import java.util.List;

/**
 * AdminPanel - Administrative interface for managing the Oak Donuts system
 *
 * This provides full CRUD (Create, Read, Update, Delete) operations for:
 * 1. Menu Items - add, edit, delete items from the menu
 * 2. Orders - view and delete customer orders
 *
 * Access is password-protected through OakDonutsLauncher
 */
public class AdminPanel extends JFrame {

    // ===== DATABASE ACCESS OBJECTS =====
    private MenuItemDAO menuItemDAO;      // Manages menu item database operations
    private OrderDAO orderDAO;            // Manages order database operations
    private OrderItemDAO orderItemDAO;    // Manages order item database operations

    // ===== MENU ITEM TAB COMPONENTS =====
    private JTable menuItemTable;                     // Table showing all menu items
    private DefaultTableModel menuItemTableModel;     // Model for menu item table data
    // Form fields for menu item CRUD operations
    private JTextField menuIdField, menuNameField, menuPriceField, menuCategoryField;

    // ===== ORDER TAB COMPONENTS =====
    private JTable orderTable;                        // Table showing all orders
    private DefaultTableModel orderTableModel;        // Model for order table data
    private JTable orderDetailsTable;                 // Table showing items in selected order
    private DefaultTableModel orderDetailsTableModel; // Model for order details

    /**
     * Constructor - sets up the admin panel with two tabs
     */
    public AdminPanel() {
        // Initialize database access objects
        menuItemDAO = new MenuItemDAO();
        orderDAO = new OrderDAO();
        orderItemDAO = new OrderItemDAO();

        // Configure main window
        setTitle("Oak Donuts - Admin Panel");
        setSize(1200, 700);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE); // Close only this window, not entire app
        setLocationRelativeTo(null); // Center on screen

        // ===== CREATE TABBED INTERFACE =====
        JTabbedPane tabbedPane = new JTabbedPane();
        tabbedPane.addTab("Menu Items", createMenuItemPanel());  // Tab 1: Manage menu items
        tabbedPane.addTab("Orders", createOrderPanel());         // Tab 2: View/delete orders

        add(tabbedPane);

        // Load initial data from database
        loadMenuItems();
        loadOrders();
    }

    /**
     * Create the Menu Items tab for CRUD operations on menu items
     */
    private JPanel createMenuItemPanel() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // ===== LEFT SIDE: FORM PANEL =====
        JPanel formPanel = new JPanel(new GridBagLayout());
        formPanel.setBorder(BorderFactory.createTitledBorder("Menu Item Details"));
        formPanel.setPreferredSize(new Dimension(350, 0)); // Fixed width

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);  // Padding around components
        gbc.anchor = GridBagConstraints.WEST;  // Align to left
        gbc.fill = GridBagConstraints.HORIZONTAL;  // Stretch horizontally

        // ID field (read-only - auto-generated by database)
        gbc.gridx = 0; gbc.gridy = 0;
        formPanel.add(new JLabel("ID:"), gbc);
        gbc.gridx = 1;
        menuIdField = new JTextField(20);
        menuIdField.setEditable(false);  // Can't manually set ID
        formPanel.add(menuIdField, gbc);

        // Name field
        gbc.gridx = 0; gbc.gridy = 1;
        formPanel.add(new JLabel("Name:"), gbc);
        gbc.gridx = 1;
        menuNameField = new JTextField(20);
        formPanel.add(menuNameField, gbc);

        // Price field
        gbc.gridx = 0; gbc.gridy = 2;
        formPanel.add(new JLabel("Price:"), gbc);
        gbc.gridx = 1;
        menuPriceField = new JTextField(20);
        formPanel.add(menuPriceField, gbc);

        // Category field
        gbc.gridx = 0; gbc.gridy = 3;
        formPanel.add(new JLabel("Category:"), gbc);
        gbc.gridx = 1;
        menuCategoryField = new JTextField(20);
        formPanel.add(menuCategoryField, gbc);

        // ===== CRUD BUTTONS =====
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));

        JButton insertBtn = new JButton("Insert");
        JButton updateBtn = new JButton("Update");
        JButton deleteBtn = new JButton("Delete");
        JButton clearBtn = new JButton("Clear");

        // Attach action listeners
        insertBtn.addActionListener(e -> insertMenuItem());
        updateBtn.addActionListener(e -> updateMenuItem());
        deleteBtn.addActionListener(e -> deleteMenuItem());
        clearBtn.addActionListener(e -> clearMenuItemForm());

        buttonPanel.add(insertBtn);
        buttonPanel.add(updateBtn);
        buttonPanel.add(deleteBtn);
        buttonPanel.add(clearBtn);

        gbc.gridx = 0; gbc.gridy = 4; gbc.gridwidth = 2;
        formPanel.add(buttonPanel, gbc);

        panel.add(formPanel, BorderLayout.WEST);

        // ===== RIGHT SIDE: TABLE PANEL =====
        JPanel tablePanel = new JPanel(new BorderLayout());
        tablePanel.setBorder(BorderFactory.createTitledBorder("Menu Items"));

        // Define table columns
        String[] columnNames = {"ID", "Name", "Price", "Category"};

        // Create table model with read-only cells
        menuItemTableModel = new DefaultTableModel(columnNames, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;  // All cells read-only
            }
        };

        menuItemTable = new JTable(menuItemTableModel);

        // When a row is selected, load that item's data into the form
        menuItemTable.getSelectionModel().addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting() && menuItemTable.getSelectedRow() != -1) {
                loadMenuItemToForm();
            }
        });

        JScrollPane scrollPane = new JScrollPane(menuItemTable);
        tablePanel.add(scrollPane, BorderLayout.CENTER);

        // Refresh button at bottom
        JButton refreshBtn = new JButton("Refresh");
        refreshBtn.addActionListener(e -> loadMenuItems());
        JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        bottomPanel.add(refreshBtn);
        tablePanel.add(bottomPanel, BorderLayout.SOUTH);

        panel.add(tablePanel, BorderLayout.CENTER);

        return panel;
    }

    /**
     * Create the Orders tab for viewing and deleting orders
     */
    private JPanel createOrderPanel() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // ===== SPLIT PANE: ORDERS ON TOP, ORDER DETAILS ON BOTTOM =====
        JSplitPane splitPane = new JSplitPane(JSplitPane.VERTICAL_SPLIT);
        splitPane.setResizeWeight(0.5);  // Equal space to both sections

        // ===== TOP SECTION: ORDERS TABLE =====
        JPanel ordersPanel = new JPanel(new BorderLayout());
        ordersPanel.setBorder(BorderFactory.createTitledBorder("Orders"));

        String[] orderColumns = {"ID", "Date", "Subtotal", "Tax", "Total"};
        orderTableModel = new DefaultTableModel(orderColumns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;  // Read-only
            }
        };

        orderTable = new JTable(orderTableModel);

        // When an order is selected, show its details below
        orderTable.getSelectionModel().addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting() && orderTable.getSelectedRow() != -1) {
                loadOrderDetails();
            }
        });

        JScrollPane orderScrollPane = new JScrollPane(orderTable);
        ordersPanel.add(orderScrollPane, BorderLayout.CENTER);

        // Buttons: Delete and Refresh
        JPanel orderButtonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        JButton deleteOrderBtn = new JButton("Delete Selected Order");
        JButton refreshOrderBtn = new JButton("Refresh");

        deleteOrderBtn.addActionListener(e -> deleteOrder());
        refreshOrderBtn.addActionListener(e -> loadOrders());

        orderButtonPanel.add(deleteOrderBtn);
        orderButtonPanel.add(refreshOrderBtn);
        ordersPanel.add(orderButtonPanel, BorderLayout.SOUTH);

        splitPane.setTopComponent(ordersPanel);

        // ===== BOTTOM SECTION: ORDER DETAILS TABLE =====
        JPanel detailsPanel = new JPanel(new BorderLayout());
        detailsPanel.setBorder(BorderFactory.createTitledBorder("Order Details"));

        String[] detailColumns = {"Item ID", "Item Name", "Quantity", "Icing", "Filling", "Price", "Total"};
        orderDetailsTableModel = new DefaultTableModel(detailColumns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;  // Read-only
            }
        };

        orderDetailsTable = new JTable(orderDetailsTableModel);

        JScrollPane detailScrollPane = new JScrollPane(orderDetailsTable);
        detailsPanel.add(detailScrollPane, BorderLayout.CENTER);

        splitPane.setBottomComponent(detailsPanel);

        panel.add(splitPane, BorderLayout.CENTER);

        return panel;
    }

    // ========================================
    // MENU ITEM OPERATIONS
    // ========================================

    /**
     * Load all menu items from database into the table
     */
    private void loadMenuItems() {
        menuItemTableModel.setRowCount(0);  // Clear existing rows
        List<MenuItem> items = menuItemDAO.getAll();  // Get all from database

        // Add each item as a row in the table
        for (MenuItem item : items) {
            menuItemTableModel.addRow(new Object[]{
                    item.getId(),
                    item.getName(),
                    String.format("$%.2f", item.getPrice()),
                    item.getCategory()
            });
        }
    }

    /**
     * Load the selected menu item's data into the form fields
     * This allows editing or deleting the item
     */
    private void loadMenuItemToForm() {
        int row = menuItemTable.getSelectedRow();
        menuIdField.setText(menuItemTable.getValueAt(row, 0).toString());
        menuNameField.setText(menuItemTable.getValueAt(row, 1).toString());

        // Remove $ sign from price for editing
        String price = menuItemTable.getValueAt(row, 2).toString().replace("$", "");
        menuPriceField.setText(price);

        menuCategoryField.setText(menuItemTable.getValueAt(row, 3).toString());
    }

    /**
     * Insert a new menu item into the database
     */
    private void insertMenuItem() {
        try {
            // Get values from form
            String name = menuNameField.getText().trim();
            double price = Double.parseDouble(menuPriceField.getText().trim());
            String category = menuCategoryField.getText().trim();

            // Validate input
            if (name.isEmpty() || category.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please fill all fields!", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            // Create new MenuItem (ID is 0 because it's auto-generated)
            MenuItem item = new MenuItem(0, name, price, category);
            menuItemDAO.insert(item);  // Save to database

            loadMenuItems();  // Refresh table
            clearMenuItemForm();  // Clear form
            JOptionPane.showMessageDialog(this, "Menu item inserted successfully!");

        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, "Invalid price format!", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    /**
     * Update an existing menu item in the database
     */
    private void updateMenuItem() {
        try {
            // Check if an item is selected
            if (menuIdField.getText().isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please select a menu item to update!", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            // Get values from form
            int id = Integer.parseInt(menuIdField.getText());
            String name = menuNameField.getText().trim();
            double price = Double.parseDouble(menuPriceField.getText().trim());
            String category = menuCategoryField.getText().trim();

            // Validate input
            if (name.isEmpty() || category.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please fill all fields!", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            // Update the item in database
            MenuItem item = new MenuItem(id, name, price, category);
            menuItemDAO.update(item);

            loadMenuItems();  // Refresh table
            clearMenuItemForm();  // Clear form
            JOptionPane.showMessageDialog(this, "Menu item updated successfully!");

        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, "Invalid input format!", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    /**
     * Delete a menu item from the database
     */
    private void deleteMenuItem() {
        try {
            // Check if an item is selected
            if (menuIdField.getText().isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please select a menu item to delete!", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            }

            // Confirm deletion
            int confirm = JOptionPane.showConfirmDialog(this,
                    "Are you sure you want to delete this menu item?",
                    "Confirm Delete",
                    JOptionPane.YES_NO_OPTION);

            if (confirm == JOptionPane.YES_OPTION) {
                // Get item data
                int id = Integer.parseInt(menuIdField.getText());
                String name = menuNameField.getText();
                double price = Double.parseDouble(menuPriceField.getText());
                String category = menuCategoryField.getText();

                // Delete from database
                MenuItem item = new MenuItem(id, name, price, category);
                menuItemDAO.delete(item);

                loadMenuItems();  // Refresh table
                clearMenuItemForm();  // Clear form
                JOptionPane.showMessageDialog(this, "Menu item deleted successfully!");
            }
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, "Error deleting menu item!", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    /**
     * Clear all fields in the menu item form
     */
    private void clearMenuItemForm() {
        menuIdField.setText("");
        menuNameField.setText("");
        menuPriceField.setText("");
        menuCategoryField.setText("");
    }

    // ========================================
    // ORDER OPERATIONS
    // ========================================

    /**
     * Load all orders from database into the orders table
     */
    private void loadOrders() {
        orderTableModel.setRowCount(0);  // Clear existing rows
        List<Order> orders = orderDAO.getAll();  // Get all orders
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

        // Add each order as a row
        for (Order order : orders) {
            orderTableModel.addRow(new Object[]{
                    order.getId(),
                    order.getOrderDate().format(formatter),
                    String.format("$%.2f", order.getSubtotal()),
                    String.format("$%.2f", order.getTax()),
                    String.format("$%.2f", order.getTotal())
            });
        }
    }

    /**
     * Load details (individual items) for the selected order
     */
    private void loadOrderDetails() {
        orderDetailsTableModel.setRowCount(0);  // Clear existing details
        int row = orderTable.getSelectedRow();
        if (row == -1) return;  // No order selected

        // Get order ID from selected row
        int orderId = Integer.parseInt(orderTable.getValueAt(row, 0).toString());

        // Get all items in this order
        List<OrderItem> items = orderItemDAO.getByOrderId(orderId);

        // Add each item to the details table
        for (OrderItem item : items) {
            orderDetailsTableModel.addRow(new Object[]{
                    item.getMenuItemId(),
                    item.getItemName(),
                    item.getQuantity(),
                    item.getIcing() != null ? item.getIcing() : "-",
                    item.getFilling() != null ? item.getFilling() : "-",
                    String.format("$%.2f", item.getPrice()),
                    String.format("$%.2f", item.getTotal())
            });
        }
    }

    /**
     * Delete the selected order and all its items from database
     */
    private void deleteOrder() {
        int row = orderTable.getSelectedRow();
        if (row == -1) {
            JOptionPane.showMessageDialog(this, "Please select an order to delete!", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // Confirm deletion
        int confirm = JOptionPane.showConfirmDialog(this,
                "Are you sure you want to delete this order and all its items?",
                "Confirm Delete",
                JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            int orderId = Integer.parseInt(orderTable.getValueAt(row, 0).toString());
            Order order = orderDAO.get(orderId).orElse(null);

            if (order != null) {
                // Delete order (this also deletes order items due to foreign key cascade or DAO logic)
                orderDAO.delete(order);

                loadOrders();  // Refresh orders table
                orderDetailsTableModel.setRowCount(0);  // Clear details
                JOptionPane.showMessageDialog(this, "Order deleted successfully!");
            }
        }
    }

    /**
     * Main method - can launch admin panel directly for testing
     */
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            try {
                UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
            } catch (Exception e) {
                e.printStackTrace();
            }

            AdminPanel panel = new AdminPanel();
            panel.setVisible(true);
        });
    }
}
